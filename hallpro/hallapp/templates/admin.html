<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Sangamner College</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)),
        url('https://images.unsplash.com/photo-1562774053-701939374585?ixlib=rb-4.0.3&q=80&w=1920') center/cover fixed;
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .sidebar {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      min-height: 100vh;
      padding: 20px 0;
      border-right: 1px solid rgba(255, 255, 255, 0.2);
    }

    .sidebar-nav {
      list-style: none;
      padding: 0;
    }

    .sidebar-nav li {
      padding: 0;
    }

    .sidebar-nav a {
      display: block;
      padding: 15px 25px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      transition: all 0.3s;
      border-left: 4px solid transparent;
    }

    .sidebar-nav a:hover,
    .sidebar-nav a.active {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
      border-left-color: white;
    }

    .navbar {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      /* FIX: Ensure navbar is above other content */
      position: relative;
      z-index: 1050;
    }

    .navbar-brand {
      font-weight: bold;
      font-size: 1.3rem;
      color: #fff !important;
    }

    .admin-header {
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      margin-bottom: 30px;
      border-radius: 10px;
    }

    .admin-header h1 {
      margin: 0;
      color: #fff;
    }

    .stats-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
    }

    .stats-card h3 {
      margin-top: 15px;
      color: #fff;
      font-weight: bold;
    }

    .stats-card .number {
      font-size: 2.5rem;
      font-weight: bold;
      color: #667eea;
    }

    .stats-card .icon {
      font-size: 2.5rem;
      color: #667eea;
      opacity: 0.2;
    }

    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      color: #fff;
    }

    .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px 10px 0 0 !important;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .table-responsive {
      background: transparent;
      border-radius: 10px;
      overflow: hidden;
    }

    .table {
      color: #fff;
    }

    .logout-btn {
      background: #dc3545;
    }

    .logout-btn:hover {
      background: #c82333;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .breadcrumb {
      background-color: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 10px;
      padding: 10px 15px;
    }

    .breadcrumb-item a {
      color: #fff;
    }

    .breadcrumb-item.active {
      color: #fff;
    }

    /* Profile Dropdown Styles - UPDATED FOR VISIBILITY */
    .dropdown-toggle {
      color: #fff !important;
      background: rgba(255, 255, 255, 0.1) !important;
      border: 1px solid rgba(255, 255, 255, 0.3) !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 8px 16px !important;
      border-radius: 8px !important;
      transition: all 0.3s ease !important;
    }

    .dropdown-toggle:hover {
      background: rgba(255, 255, 255, 0.2) !important;
      border-color: rgba(255, 255, 255, 0.5) !important;
      transform: translateY(-1px);
    }

    .dropdown-menu {
      background: rgba(255, 255, 255, 0.98) !important;
      /* Made more solid for contrast */
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.3) !important;
      border-radius: 12px !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;

      /* FIX: Positioning and Z-Index */
      position: absolute !important;
      z-index: 9999 !important;
      right: 0 !important;
      left: auto !important;
      margin-top: 10px !important;
      min-width: 200px !important;
    }

    .dropdown-menu.show {
      display: block !important;
    }

    .dropdown-header {
      color: #333 !important;
      font-weight: 600;
      background: rgba(102, 126, 234, 0.1);
      padding: 10px 15px;
      border-radius: 8px 8px 0 0;
    }

    .dropdown-item {
      color: #333 !important;
      padding: 10px 20px !important;
    }

    .dropdown-item:hover {
      background: rgba(102, 126, 234, 0.1) !important;
      color: #667eea !important;
    }

    /* Main Content Container Fix */
    .main-content-column {
      position: relative;
      z-index: 10;
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-3 sidebar">
        <div
          style="padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.2); margin-bottom: 20px;">
          <i class="fas fa-user-tie" style="font-size: 3rem; color: white; margin-bottom: 10px; display: block;"></i>
          <h5 style="color: white; margin: 0;">Admin Panel</h5>
        </div>
        <ul class="sidebar-nav">
          <li><a href="#" onclick="switchSection('dashboard')" class="active"><i class="fas fa-chart-line"></i>
              Dashboard</a></li>
          <li><a href="#" onclick="switchSection('bookings')"><i class="fas fa-calendar-check"></i> Hall Bookings</a>
          </li>
          <li><a href="#" onclick="switchSection('halls')"><i class="fas fa-door-open"></i> Manage Halls</a></li>
          <li><a href="#" onclick="switchSection('users')"><i class="fas fa-users"></i> Users</a></li>
          <li><a href="#" onclick="switchSection('reports')"><i class="fas fa-file-alt"></i> Reports</a></li>
          <li style="border-top: 1px solid rgba(255,255,255,0.2); margin-top: 20px;"><a href="/logout/"
              class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
      </div>

      <div class="col-md-9 main-content-column">
        <nav class="navbar navbar-expand-lg">
          <div class="container-fluid">
            <span class="navbar-brand">Sangamner College - Hall Booking System</span>
            <div class="ms-auto">
              <div class="dropdown">
                <button class="btn dropdown-toggle d-flex align-items-center" type="button" id="adminProfileDropdown"
                  data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-user-circle me-2"></i>
                  <span>{{ admin.get_full_name|default:admin.username }}</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminProfileDropdown">
                  <li>
                    <h6 class="dropdown-header">{{ admin.get_full_name|default:admin.username }}</h6>
                  </li>
                  <li>
                    <hr class="dropdown-divider">
                  </li>
                  <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Profile</a></li>
                  <li><a class="dropdown-item" href="{% url 'admin-dashboard' %}"><i
                        class="fas fa-tachometer-alt me-2"></i>Dashboard</a></li>
                  <li>
                    <hr class="dropdown-divider">
                  </li>
                  <li><a class="dropdown-item" href="{% url 'logout' %}"><i
                        class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                </ul>
              </div>
            </div>
          </div>
        </nav>

        <div class="admin-header mt-3">
          <h1 id="section-title">Admin Dashboard</h1>
        </div>

        <div style="padding: 0 20px;">
          <div id="dashboard" class="section active">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item active">Dashboard</li>
              </ol>
            </nav>

            <div class="row">
              <div class="col-md-12">
                <div class="card">
                  <div class="card-header">
                    <h5 class="mb-0">Dashboard Overview</h5>
                  </div>
                  <div class="card-body">
                    <div style="max-width: 400px; width: 100%;">
                      <canvas id="overviewChart" data-halls="{{ total_halls|default:'0' }}"
                        data-bookings="{{ total_bookings|default:'0' }}" data-users="{{ users_count|default:'0' }}"
                        data-pending="{{ pending_bookings|default:'0' }}"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-3">
                <div class="stats-card text-center">
                  <i class="fas fa-door-open icon"></i>
                  <div class="number">{{ total_halls|default:'0' }}</div>
                  <h3>Total Halls</h3>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stats-card text-center">
                  <i class="fas fa-calendar-check icon"></i>
                  <div class="number">{{ total_bookings|default:'0' }}</div>
                  <h3>Total Bookings</h3>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stats-card text-center">
                  <i class="fas fa-users icon"></i>
                  <div class="number">{{ users_count|default:'0' }}</div>
                  <h3>Total Users</h3>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stats-card text-center">
                  <i class="fas fa-clock icon"></i>
                  <div class="number">{{ pending_bookings|default:'0' }}</div>
                  <h3>Pending Bookings</h3>
                </div>
              </div>
            </div>

            <div class="card mt-4">
              <div class="card-header">
                <h5 class="mb-0">Recent Bookings</h5>
              </div>
              <div class="card-body">
                {% if recent_bookings %}
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Hall Name</th>
                        <th>User</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for booking in recent_bookings %}
                      <tr>
                        <td>{{ booking.hall.name }}</td>
                        <td>{{ booking.user.get_full_name|default:booking.user.username }}</td>
                        <td>{{ booking.booking_date }}</td>
                        <td>
                          {% if booking.status == 'APPROVED' %}
                          <span class="badge bg-success">Approved</span>
                          {% elif booking.status == 'PENDING' %}
                          <span class="badge bg-warning">Pending</span>
                          {% elif booking.status == 'REJECTED' %}
                          <span class="badge bg-danger">Rejected</span>
                          {% else %}
                          <span class="badge bg-secondary">{{ booking.status }}</span>
                          {% endif %}
                        </td>
                        <td><button class="btn btn-sm btn-primary"
                            onclick="viewBookingDetails('{{ booking.id }}')">View</button></td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                  <p class="text-muted">No bookings found.</p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>

          <div id="bookings" class="section">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#" onclick="switchSection('dashboard')">Dashboard</a></li>
                <li class="breadcrumb-item active">Hall Bookings</li>
              </ol>
            </nav>

            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">All Hall Bookings</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Booking ID</th>
                        <th>Hall Name</th>
                        <th>User Name</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for booking in all_bookings %}
                      <tr>
                        <td>#{{ booking.id|stringformat:"03d" }}</td>
                        <td>{{ booking.hall.name }}</td>
                        <td>{{ booking.user.get_full_name|default:booking.user.username }}</td>
                        <td>{{ booking.booking_date|date:"d M Y" }}</td>
                        <td>{{ booking.start_time }} - {{ booking.end_time }}</td>
                        <td>
                          {% if booking.status == 'APPROVED' %}
                          <span class="badge bg-success">Approved</span>
                          {% elif booking.status == 'PENDING' %}
                          <span class="badge bg-warning">Pending</span>
                          {% elif booking.status == 'REJECTED' %}
                          <span class="badge bg-danger">Rejected</span>
                          {% else %}
                          <span class="badge bg-secondary">{{ booking.status }}</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if booking.status == 'PENDING' %}
                          <button class="btn btn-sm btn-success"
                            onclick="updateBookingStatus('{{ booking.id }}', 'APPROVED')"><i class="fas fa-check"></i>
                            Approve</button>
                          <button class="btn btn-sm btn-danger"
                            onclick="updateBookingStatus('{{ booking.id }}', 'REJECTED')"><i class="fas fa-times"></i>
                            Reject</button>
                          {% elif booking.status == 'REJECTED' %}
                          <button class="btn btn-sm btn-warning"
                            onclick="updateBookingStatus('{{ booking.id }}', 'APPROVED')"><i class="fas fa-redo"></i>
                            Reconsider</button>
                          {% else %}
                          <button class="btn btn-sm btn-warning"
                            onclick="updateBookingStatus('{{ booking.id }}', 'PENDING')"><i class="fas fa-undo"></i>
                            Reset</button>
                          {% endif %}
                          <button class="btn btn-sm btn-danger ms-2" onclick="deleteBooking('{{ booking.id }}')"><i
                              class="fas fa-trash"></i> Delete</button>
                        </td>
                      </tr>
                      {% empty %}
                      <tr>
                        <td colspan="7" class="text-center text-muted">No bookings found.</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div id="halls" class="section">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#" onclick="switchSection('dashboard')">Dashboard</a></li>
                <li class="breadcrumb-item active">Manage Halls</li>
              </ol>
            </nav>
            <div class="row mb-3">
              <div class="col-md-12">
                <button class="btn btn-primary" onclick="showAddHallModal()"><i class="fas fa-plus"></i> Add New
                  Hall</button>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Available Halls</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Hall Name</th>
                        <th>Capacity</th>
                        <th>Location</th>
                        <th>Status</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for hall in halls %}
                      <tr>
                        <td>{{ hall.name }}</td>
                        <td>{{ hall.capacity }}</td>
                        <td>{{ hall.location }}</td>
                        <td><span class="badge {% if hall.is_active %}bg-success{% else %}bg-secondary{% endif %}">{{
                            hall.is_active|yesno:"Active,Inactive" }}</span></td>
                        <td>
                          <button class="btn btn-sm btn-info" onclick="editHall('{{ hall.id }}')"><i
                              class="fas fa-edit"></i> Edit</button>
                          <button class="btn btn-sm btn-danger" onclick="deleteHall('{{ hall.id }}')"><i
                              class="fas fa-trash"></i> Delete</button>
                        </td>
                      </tr>
                      {% empty %}
                      <tr>
                        <td colspan="5" class="text-center">No halls found</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div id="users" class="section">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#" onclick="switchSection('dashboard')">Dashboard</a></li>
                <li class="breadcrumb-item active">Users</li>
              </ol>
            </nav>
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Registered Users</h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal"><i
                    class="fas fa-plus me-2"></i>Add User</button>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Type</th>
                        <th>Bookings</th>
                        <th>Status</th>
                        <th>Joined</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for user in users %}
                      <tr>
                        <td>#U{{ user.id|stringformat:"03d" }}</td>
                        <td>{{ user.get_full_name|default:user.username }}</td>
                        <td>{{ user.email }}</td>
                        <td><span
                            class="badge {% if user.user_type == 'admin' %}bg-danger{% elif user.user_type == 'user' %}bg-primary{% else %}bg-secondary{% endif %}">
                            {{ user.user_type|title }}</span></td>
                        <td>{{ user.bookings.count }}</td>
                        <td><span class="badge {% if user.is_active %}bg-success{% else %}bg-danger{% endif %}">
                            {{ user.is_active|yesno:"Active,Blocked" }}</span></td>
                        <td>{{ user.date_joined|date:"d M Y" }}</td>
                        <td class="text-nowrap">
                          <button class="btn btn-sm btn-info me-1" data-user-id="{{ user.id }}"
                            data-user-name="{{ user.get_full_name|default:user.username|escapejs }}"
                            data-user-email="{{ user.email }}" data-user-type="{{ user.user_type }}"
                            onclick="editUser(this)" title="Edit User"><i class="fas fa-edit"></i></button>
                          <button
                            class="btn btn-sm {% if user.is_active %}btn-warning{% else %}btn-success{% endif %} me-1"
                            data-user-id="{{ user.id }}" data-user-active="{{ user.is_active }}"
                            onclick="toggleUserStatus(this)"
                            title="{% if user.is_active %}Block User{% else %}Unblock User{% endif %}">
                            {% if user.is_active %}<i class="fas fa-ban"></i> Block{% else %}<i
                              class="fas fa-check"></i> Unblock{% endif %}
                          </button>
                          <button class="btn btn-sm btn-danger" data-user-id="{{ user.id }}"
                            data-user-name="{{ user.get_full_name|default:user.username|escapejs }}"
                            onclick="deleteUser(this)" title="Delete User">
                            <i class="fas fa-trash"></i>
                          </button>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div id="reports" class="section">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#" onclick="switchSection('dashboard')">Dashboard</a></li>
                <li class="breadcrumb-item active">Reports</li>
              </ol>
            </nav>
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Booking Reports</h5>
              </div>
              <div class="card-body">
                <p>Monthly statistics and reports will be displayed here.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="bookingDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Booking Details</h5><button type="button" class="btn-close"
            data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="bookingDetailsContent"></div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New User</h5><button type="button" class="btn-close"
            data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addUserForm">{% csrf_token %}<div class="mb-3"><label class="form-label">Full Name</label><input
                type="text" class="form-control" id="addUserName" required></div>
            <div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control"
                id="addUserEmail" required></div>
            <div class="mb-3"><label class="form-label">Password</label><input type="password" class="form-control"
                id="addUserPassword" required></div>
            <div class="mb-3"><label class="form-label">User Type</label><select class="form-select" id="addUserType">
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select></div>
          </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary"
            data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" onclick="addUser()">Add
            User</button></div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit User</h5><button type="button" class="btn-close"
            data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editUserForm">{% csrf_token %}<input type="hidden" id="editUserId">
            <div class="mb-3"><label class="form-label">Full Name</label><input type="text" class="form-control"
                id="editUserName" required></div>
            <div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control"
                id="editUserEmail" required></div>
            <div class="mb-3"><label class="form-label">User Type</label><select class="form-select" id="editUserType">
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select></div>
            <div class="mb-3">
              <div class="form-check"><input class="form-check-input" type="checkbox" id="editUserActive"><label
                  class="form-check-label" for="editUserActive">Active</label></div>
            </div>
          </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary"
            data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary"
            onclick="updateUser()">Update User</button></div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="addHallModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Hall</h5><button type="button" class="btn-close"
            data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addHallForm">{% csrf_token %}<div class="mb-3"><label class="form-label">Hall Name</label><input
                type="text" class="form-control" id="hallName" required></div>
            <div class="mb-3"><label class="form-label">Capacity</label><input type="number" class="form-control"
                id="hallCapacity" required></div>
            <div class="mb-3"><label class="form-label">Location</label><input type="text" class="form-control"
                id="hallLocation" required></div>
          </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary"
            data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" onclick="addHall()">Add
            Hall</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Chart Initializer
    document.addEventListener('DOMContentLoaded', function () {
      const chartCanvas = document.getElementById('overviewChart');
      const ctx = chartCanvas.getContext('2d');
      const chartData = [
        chartCanvas.dataset.halls,
        chartCanvas.dataset.bookings,
        chartCanvas.dataset.users,
        chartCanvas.dataset.pending
      ];

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Halls', 'Bookings', 'Users', 'Pending'],
          datasets: [{
            label: 'System Overview',
            data: chartData,
            borderColor: 'rgba(102, 126, 234, 1)',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: 'rgba(102, 126, 234, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)',
                borderColor: 'rgba(255, 255, 255, 0.2)'
              },
              ticks: {
                color: '#fff',
                font: {
                  size: 12,
                  family: 'Arial, sans-serif'
                }
              }
            },
            x: {
              grid: {
                color: 'rgba(255, 255, 255, 0.1)',
                borderColor: 'rgba(255, 255, 255, 0.2)'
              },
              ticks: {
                color: '#fff',
                font: {
                  size: 12,
                  family: 'Arial, sans-serif'
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.9)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: 'rgba(255, 255, 255, 0.3)',
              borderWidth: 2,
              padding: 15,
              displayColors: true,
              cornerRadius: 8,
              callbacks: {
                label: function (context) {
                  const label = context.label || '';
                  const value = context.parsed.y || 0;
                  return `${label}: ${value}`;
                }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          },
          animation: {
            duration: 2000,
            easing: 'easeInOutQuart'
          }
        }
      });
    });

    // Helper: CSRF Cookie
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Navigation
    function switchSection(sectionId) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
      event.currentTarget.classList.add('active');

      const titles = { 'dashboard': 'Admin Dashboard', 'bookings': 'Hall Bookings', 'halls': 'Manage Halls', 'users': 'Users', 'reports': 'Reports' };
      document.getElementById('section-title').textContent = titles[sectionId];
    }

    // API Handlers (Placeholders for your backend logic)
    function addHall() {
      const name = document.getElementById('hallName').value;
      const capacity = document.getElementById('hallCapacity').value;
      const location = document.getElementById('hallLocation').value;

      if (!name || !capacity || !location) {
        alert('Please fill all required fields');
        return;
      }

      fetch('/api/add-hall/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ name: name, capacity: parseInt(capacity), location: location, is_active: true })
      })
        .then(response => {
          console.log('Response status:', response.status);
          if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
          }
          return response.json();
        })
        .then(data => {
          console.log('Response data:', data);
          if (data.success) {
            // Hide modal
            bootstrap.Modal.getInstance(document.getElementById('addHallModal')).hide();

            // Clear form
            document.getElementById('addHallForm').reset();

            alert('Hall added successfully!');

            // Reload page to show the new hall from database
            window.location.reload();
          } else {
            alert('Error: ' + (data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while adding the hall: ' + error.message);
        });
    }

    function updateBookingStatus(id, status) {
      if (!confirm(`Are you sure you want to ${status.toLowerCase()}?`)) return;
      fetch(`/api/update-booking/${id}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ status: status })
      }).then(r => r.json()).then(d => d.success ? window.location.reload() : alert(d.message));
    }

    function deleteBooking(id) {
      if (!confirm('Permanent delete?')) return;
      fetch(`/api/delete-booking/${id}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
      }).then(r => r.json()).then(d => d.success ? window.location.reload() : alert(d.message));
    }

    function viewBookingDetails(id) {
      window.open(`/booking-details/${id}/`, '_blank');
    }

    function showAddHallModal() {
      new bootstrap.Modal(document.getElementById('addHallModal')).show();
    }

    function editHall(hallId) {
      // For now, use hardcoded data since table is static
      // In a real application, this would come from database
      let currentName = 'Main Auditorium';
      let currentCapacity = '500';
      let currentLocation = 'Block A';
      let currentActive = false;

      // Try to get data from table if it exists
      const hallRow = document.querySelector('#halls button[onclick*="' + hallId + '"]');
      if (hallRow) {
        const row = hallRow.closest('tr');
        if (row) {
          currentName = row.querySelector('td:nth-child(1)').textContent.trim();
          currentCapacity = row.querySelector('td:nth-child(2)').textContent.trim();
          currentLocation = row.querySelector('td:nth-child(3)').textContent.trim();

          // Get active status from badge
          const statusBadge = row.querySelector('td:nth-child(4) .badge');
          if (statusBadge) {
            currentActive = statusBadge.textContent.trim() === 'Active';
          }
        }
      }

      // Remove existing modal if present
      const existingModal = document.getElementById('editHallModal');
      if (existingModal) {
        existingModal.remove();
      }

      // Create modal HTML
      const modalHtml = '<div class="modal fade" id="editHallModal" tabindex="-1">' +
        '<div class="modal-dialog">' +
        '<div class="modal-content">' +
        '<div class="modal-header">' +
        '<h5 class="modal-title">Edit Hall</h5>' +
        '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>' +
        '</div>' +
        '<div class="modal-body">' +
        '<form id="editHallForm">' +
        '<input type="hidden" id="editHallId" value="' + hallId + '">' +
        '<div class="mb-3">' +
        '<label class="form-label">Hall Name</label>' +
        '<input type="text" class="form-control" id="editHallName" value="' + currentName + '" required>' +
        '</div>' +
        '<div class="mb-3">' +
        '<label class="form-label">Capacity</label>' +
        '<input type="number" class="form-control" id="editHallCapacity" value="' + currentCapacity + '" required>' +
        '</div>' +
        '<div class="mb-3">' +
        '<label class="form-label">Location</label>' +
        '<input type="text" class="form-control" id="editHallLocation" value="' + currentLocation + '" required>' +
        '</div>' +
        '<div class="mb-3">' +
        '<div class="form-check">' +
        '<input class="form-check-input" type="checkbox" id="editHallActive" ' + (currentActive ? 'checked="checked"' : '') + '>' +
        '<label class="form-check-label ms-2" for="editHallActive">Active</label>' +
        '</div>' +
        '</div>' +
        '</form>' +
        '</div>' +
        '<div class="modal-footer">' +
        '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>' +
        '<button type="button" class="btn btn-primary" onclick="updateHall()">Update Hall</button>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>';

      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);

      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('editHallModal'));
      modal.show();
    }

    function updateHall() {
      const hallId = document.getElementById('editHallId').value;
      const name = document.getElementById('editHallName').value;
      const capacity = document.getElementById('editHallCapacity').value;
      const location = document.getElementById('editHallLocation').value;
      const isActive = document.getElementById('editHallActive').checked;

      if (!name || !capacity || !location) {
        alert('Please fill all required fields');
        return;
      }

      fetch(`/api/update-hall/${hallId}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({
          name: name,
          capacity: parseInt(capacity),
          location: location,
          is_active: isActive
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Hide modal and remove from DOM
            bootstrap.Modal.getInstance(document.getElementById('editHallModal')).hide();
            document.getElementById('editHallModal').remove();

            // Update hall in table
            const hallRow = document.querySelector('#halls button[onclick*="' + hallId + '"]').closest('tr');
            if (hallRow) {
              hallRow.querySelector('td:nth-child(1)').textContent = name;
              hallRow.querySelector('td:nth-child(2)').textContent = capacity;
              hallRow.querySelector('td:nth-child(3)').textContent = location;

              // Update status badge
              const statusBadge = hallRow.querySelector('td:nth-child(4) .badge');
              if (statusBadge) {
                statusBadge.className = 'badge ' + (isActive ? 'bg-success' : 'bg-secondary');
                statusBadge.textContent = isActive ? 'Active' : 'Inactive';
              }
            }

            alert('Hall updated successfully!');
          } else {
            alert('Error: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while updating hall');
        });
    }

    function deleteHall(hallId) {
      if (confirm('Are you sure you want to delete this hall?')) {
        fetch(`/api/delete-hall/${hallId}/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken') }
        }).then(r => r.json()).then(d => d.success ? window.location.reload() : alert(d.message));
      }
    }

    function addUser() {
      const name = document.getElementById('addUserName').value;
      const email = document.getElementById('addUserEmail').value;
      const password = document.getElementById('addUserPassword').value;
      const userType = document.getElementById('addUserType').value;

      if (!name || !email || !password) {
        alert('Please fill all required fields');
        return;
      }

      fetch('/api/add-user/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ name: name, email: email, password: password, userType: userType })
      }).then(r => r.json()).then(d => d.success ? window.location.reload() : alert(d.message));
    }

    function editUser(button) {
      const userId = button.dataset.userId;
      const userName = button.dataset.userName;
      const userEmail = button.dataset.userEmail;
      const userType = button.dataset.userType;

      document.getElementById('editUserId').value = userId;
      document.getElementById('editUserName').value = userName;
      document.getElementById('editUserEmail').value = userEmail;
      document.getElementById('editUserType').value = userType;

      // Find the user's current status from the table
      const userRow = button.closest('tr');
      const statusBadge = userRow.querySelector('td:nth-child(6) .badge');
      const isActive = statusBadge.textContent.trim() === 'Active';
      document.getElementById('editUserActive').checked = isActive;

      new bootstrap.Modal(document.getElementById('editUserModal')).show();
    }

    function updateUser() {
      const userId = document.getElementById('editUserId').value;
      const name = document.getElementById('editUserName').value;
      const email = document.getElementById('editUserEmail').value;
      const userType = document.getElementById('editUserType').value;
      const isActive = document.getElementById('editUserActive').checked;

      if (!name || !email) {
        alert('Please fill all required fields');
        return;
      }

      fetch(`/api/update-user/${userId}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ name: name, email: email, user_type: userType, is_active: isActive })
      }).then(r => r.json()).then(d => d.success ? window.location.reload() : alert(d.message));
    }

    function toggleUserStatus(button) {
      const userId = button.dataset.userId;
      const currentStatus = button.dataset.userActive === 'true';
      const newStatus = !currentStatus;  // Toggle the status
      const action = newStatus ? 'unblock' : 'block';

      if (!confirm(`Are you sure you want to ${action} this user?`)) return;

      fetch(`/api/update-user/${userId}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
        body: JSON.stringify({ is_active: newStatus })
      }).then(r => r.json()).then(d => d.success ? window.location.reload() : alert(d.message));
    }

    function deleteUser(button) {
      const userId = button.dataset.userId;
      const userName = button.dataset.userName;

      if (!confirm(`Are you sure you want to delete user "${userName}"? This action cannot be undone.`)) return;

      fetch(`/api/delete-user/${userId}/`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }
      }).then(r => r.json()).then(d => d.success ? window.location.reload() : alert(d.message));
    }
  </script>
</body>

</html>